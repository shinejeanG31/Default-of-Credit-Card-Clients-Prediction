``````{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, eval=T)
```

```{r}
#Hey, becareful~I use additional packages.It is better to install ROCR by Tools-install Packages through the R-studio Menus
library("tidyverse")
library("ggplot2")
library("lessR")
library(dplyr)
library(tidyr)
library(viridis)
library(tidyr)
library(reshape2)
library(corrplot)
library(caret)
library(class)
library("gplots",warn.conflicts = FALSE)
library(ROCR)
install.packages("grid")
install.packages("MASS")
library(MASS)
install.packages("neuralnet")
library(neuralnet)


setwd("C:/Users/ShineJean/Documents/2019/0-2020summer/IE7275/Project/dataset")

default <- read.csv("default.csv", 
                 encoding="UTF-8", stringsAsFactors = F, na.strings = c(""))
```
rename columns and get rid of ID column 
```{r}
client<-default[,-c(1)]
colnames(client)[24]<-"October.defaulter"
colnames(client)[6]<-"PAY_1"
summary(client)
dim(client)
```
~22.12% are defaulters. 
no.na

###group  becuase 5,6 and 0 are all  unknown 
```{r}
client$EDUCATION[client$EDUCATION==0]<-4
client$EDUCATION[client$EDUCATION==5]<-4
client$EDUCATION[client$EDUCATION==6]<-4
client$MARRIAGE[client$MARRIAGE==0]<-3
client$PAY_1[client$PAY_1==0]<- -1
client$PAY_1[client$PAY_1==-2]< -1
client$PAY_2[client$PAY_2==0]<- -1
client$PAY_2[client$PAY_2==-2]<--1
client$PAY_3[client$PAY_3==0]<- -1
client$PAY_3[client$PAY_3==-2]<--1
client$PAY_4[client$PAY_4==0]<- -1
client$PAY_4[client$PAY_4==-2]<--1
client$PAY_5[client$PAY_5==0]<- -1
client$PAY_5[client$PAY_5==-2]<--1
client$PAY_6[client$PAY_6==0]<- -1
client$PAY_6[client$PAY_6==-2]<--1



```
```{r}
library(gridExtra)
p1 <- ggplot(aes(x = LIMIT_BAL), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p2 <- ggplot(aes(x = SEX), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p3 <- ggplot(aes(x = EDUCATION), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p4 <- ggplot(aes(x = MARRIAGE), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p5 <- ggplot(aes(x = AGE), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
grid.arrange(p1,p2,p3,p4,p5, ncol=2)
```
```{r}
p6 <- ggplot(aes(x = PAY_1), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p7 <- ggplot(aes(x = PAY_2), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p8 <- ggplot(aes(x = PAY_3), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p9 <- ggplot(aes(x = PAY_4), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p10 <- ggplot(aes(x = PAY_5), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p11 <- ggplot(aes(x = PAY_6), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
grid.arrange(p6,p7,p8,p9,p10,p11, ncol=2)
```



```{r}
p18<- ggplot(aes(x = PAY_AMT1), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p19<- ggplot(aes(x = PAY_AMT2), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p20<- ggplot(aes(x = PAY_AMT3), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p21<- ggplot(aes(x = PAY_AMT4), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p22<- ggplot(aes(x = PAY_AMT5), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p23<- ggplot(aes(x = PAY_AMT6), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p24<- ggplot(aes(x = October.defaulter), data = client) + geom_histogram()
grid.arrange(p18,p19,p20,p21,p22,p23,p24, ncol=2)
```

```{r}
p12<- ggplot(aes(x = BILL_AMT1), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p13<- ggplot(aes(x = BILL_AMT2), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p14<- ggplot(aes(x = BILL_AMT3), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p15<- ggplot(aes(x = BILL_AMT4), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p16<- ggplot(aes(x = BILL_AMT5), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
p17<- ggplot(aes(x = BILL_AMT6), data = client) + geom_histogram()+facet_wrap(~October.defaulter, scales = 'fixed')
grid.arrange(p12,p13,p14,p15,p16,p17,ncol=2)
```
```

```


### are there any corelation?
```{r}
c<-client[,c(1:24)]
m<-cor(c)
corrplot(m)
```


```{r}
###neural network starts here. For this model, I think it is no need to transfer charactoral variable into facter.
#Normalization for neural network (for charactoral variables only).

client3<-client
client3[c(1,5)] <- as.data.frame(lapply(client3[c(1,5)],scale,center=TRUE,scale=TRUE))
client3[12:23] <- as.data.frame(lapply(client3[12:23],scale,center=TRUE,scale=TRUE))


set.seed(12345) 
train.rows <- sample(1:nrow(client), dim(client)[1]*0.6)
train_df <- client3[train.rows,]
valid_df <- client3[-train.rows,]

```

```{r}

#Built model by neural network to train the training dataset
names(train_df)
nn_model<-neuralnet(October.defaulter~LIMIT_BAL+SEX+EDUCATION+MARRIAGE+AGE+PAY_1+PAY_2+PAY_3+PAY_4+PAY_5+PAY_6+BILL_AMT1+BILL_AMT2+BILL_AMT3+BILL_AMT4+BILL_AMT5+BILL_AMT6+PAY_AMT1+PAY_AMT2+PAY_AMT3+PAY_AMT4+PAY_AMT5+PAY_AMT6,data=train_df,hidden=2,err.fct="ce",linear.output=FALSE,threshold=0.01)

```

```{r}
#Observe the result

nn_model$result.matrix
head(nn_model$generalized.weights[[1]],10)
head(nn_model$net.result[[1]],10)
head(nn_model$response)


```

```{r}

plot(nn_model)

```
```{r}
#Observe the weights of variables
#png("1.png",width=900,height=600)
par(mfrow=c(2,3))
neuralnet::gwplot(nn_model,selected.covariate="LIMIT_BAL" )
neuralnet::gwplot(nn_model,selected.covariate="SEX" )
neuralnet::gwplot(nn_model,selected.covariate="EDUCATION" )
neuralnet::gwplot(nn_model,selected.covariate="MARRIAGE" )
neuralnet::gwplot(nn_model,selected.covariate="AGE" )
#dev.off()

#png("2.png",width=900,height=600)
par(mfrow=c(2,3))
neuralnet::gwplot(nn_model,selected.covariate="PAY_1" )
neuralnet::gwplot(nn_model,selected.covariate="PAY_2" )
neuralnet::gwplot(nn_model,selected.covariate="PAY_3" )
neuralnet::gwplot(nn_model,selected.covariate="PAY_4" )
neuralnet::gwplot(nn_model,selected.covariate="PAY_5" )
neuralnet::gwplot(nn_model,selected.covariate="PAY_6" )
#dev.off()

#png("3.png",width=900,height=600)
par(mfrow=c(2,3))
neuralnet::gwplot(nn_model,selected.covariate="BILL_AMT1" )
neuralnet::gwplot(nn_model,selected.covariate="BILL_AMT2" )
neuralnet::gwplot(nn_model,selected.covariate="BILL_AMT3" )
neuralnet::gwplot(nn_model,selected.covariate="BILL_AMT4" )
neuralnet::gwplot(nn_model,selected.covariate="BILL_AMT5" )
neuralnet::gwplot(nn_model,selected.covariate="BILL_AMT6" )
#dev.off()

#png("4.png",width=900,height=600)
par(mfrow=c(2,3))
neuralnet::gwplot(nn_model,selected.covariate="PAY_AMT1" )
neuralnet::gwplot(nn_model,selected.covariate="PAY_AMT2" )
neuralnet::gwplot(nn_model,selected.covariate="PAY_AMT3" )
neuralnet::gwplot(nn_model,selected.covariate="PAY_AMT4" )
neuralnet::gwplot(nn_model,selected.covariate="PAY_AMT5" )
neuralnet::gwplot(nn_model,selected.covariate="PAY_AMT6" )
#dev.off()
```

```{r}
#Plot ROC to find the optimal cutoff value
#png("ROC1.png",width=900,height=600)
pred<-ROCR::prediction(predictions=as.vector(nn_model$net.result),labels=nn_model$response)
par(mfrow=c(2,1))
perf<-ROCR::performance(pred,measure="tpr",x.measure="fpr")
plot(perf,colorize=TRUE,print.cutoffs.at=c(0.2,0.5,0.6))
perf<-ROCR::performance(pred,measure="acc")
plot(perf)
#dev.off()



#As shown on the plot, the optimal cutoff value is 0.5.
```

```{r}
nn.predict = neuralnet::compute(nn_model, valid_df)

predicted <- as.vector(ifelse(nn.predict$net.result > 0.5, 1, 0))
nn.table = table(valid_df$October.defaulter,predicted)
confusionMatrix<-confusionMatrix(nn.table)
confusionMatrix

#Accuracy= 0.816          

```

```{r}
#plot ROC to compare

install.packages("pROC")
library(pROC)


modelroc<-roc(valid_df$October.defaulter,predicted)
modelroc

plot(modelroc, print.auc=TRUE, auc.polygon=TRUE,legacy.axes=TRUE, grid=c(0.1, 0.2), grid.col=c("green", "red"), max.auc.polygon=TRUE,auc.polygon.col="skyblue", print.thres=TRUE)
```

```{r}
#Model optimization. 
nn_model2<-neuralnet(October.defaulter~SEX+EDUCATION+MARRIAGE+PAY_1+PAY_2+PAY_3+PAY_4+PAY_5+PAY_6+BILL_AMT2+BILL_AMT4+PAY_AMT1+PAY_AMT2+PAY_AMT3+PAY_AMT4+PAY_AMT6,data=train_df,hidden=2,err.fct="ce",linear.output=FALSE,threshold=0.01)

pred2<-ROCR::prediction(predictions=as.vector(nn_model2$net.result),labels=nn_model2$response)
par(mfrow=c(2,1))
perf2<-ROCR::performance(pred2,measure="tpr",x.measure="fpr")
plot(perf2,colorize=TRUE,print.cutoffs.at=c(0.2,0.5,0.6))
perf2<-ROCR::performance(pred2,measure="acc")
plot(perf2)

names(valid_df)

valid_df2 <- valid_df[c(2,3,4,6,7,8,9,10,11,13,15,18,19,20,21,23)]

nn.predict2 = neuralnet::compute(nn_model2, valid_df2)

predicted2 <- as.vector(ifelse(nn.predict2$net.result > 0.5, 1, 0))
nn.table = table(valid_df$October.defaulter,predicted2)
confusionMatrix<-confusionMatrix(nn.table)
confusionMatrix
#Accuracy=0.8149

modelroc2<-roc(valid_df$October.defaulter,predicted2)
modelroc2

plot(modelroc2, print.auc=TRUE, auc.polygon=TRUE,legacy.axes=TRUE, grid=c(0.1, 0.2), grid.col=c("green", "red"), max.auc.polygon=TRUE,auc.polygon.col="skyblue", print.thres=TRUE)

```

```{r}
#Model optimization2

client4<-client
client4$BILL_ATM<-rowSums(client4[,c(12:17)])
client4$PAY_ATM<-rowSums(client4[,c(18:23)])

client4[c(1,5)] <- as.data.frame(lapply(client4[c(1,5)],scale,center=TRUE,scale=TRUE))
client4[25:26] <- as.data.frame(lapply(client4[25:26],scale,center=TRUE,scale=TRUE))


set.seed(12345) 
train.rows <- sample(1:nrow(client), dim(client)[1]*0.6)
train_df1 <- client4[train.rows,]
valid_df1 <- client4[-train.rows,]

names(train_df1)
nn_model3<-neuralnet(October.defaulter~LIMIT_BAL+SEX+EDUCATION+MARRIAGE+AGE+PAY_1+PAY_2+PAY_3+PAY_4+PAY_5+PAY_6+BILL_ATM+PAY_ATM,data=train_df1,hidden=2,err.fct="ce",linear.output=FALSE,threshold=0.01)

#png("ROC2.png",width=900,height=600)
pred3<-ROCR::prediction(predictions=as.vector(nn_model3$net.result),labels=nn_model3$response)
par(mfrow=c(2,1))
perf3<-ROCR::performance(pred3,measure="tpr",x.measure="fpr")
plot(perf3,colorize=TRUE,print.cutoffs.at=c(0.2,0.5,0.6,0.8))
perf2<-ROCR::performance(pred3,measure="acc")
plot(perf3)
#dev.off()

names(valid_df1)
valid_df3 <- valid_df1[c(1:11,25,26)]
head(nn_model3$result.matrix)

nn.predict3 = neuralnet::compute(nn_model3, valid_df3)

predicted3 <- as.vector(ifelse(nn.predict3$net.result > 0.5, 1, 0))
nn.table = table(valid_df$October.defaulter,predicted3)
confusionMatrix<-confusionMatrix(nn.table)
confusionMatrix
#Accuracy=0.8166

modelroc3<-roc(valid_df$October.defaulter,predicted3)
modelroc3

plot(modelroc3, print.auc=TRUE, auc.polygon=TRUE,legacy.axes=TRUE, grid=c(0.1, 0.2), grid.col=c("green", "red"), max.auc.polygon=TRUE,auc.polygon.col="skyblue", print.thres=TRUE)


```
```{r}
plot(nn_model3)
```

```{r}

#show the result of predicted probability
head(nn.predict3$net.result,20)
```



















